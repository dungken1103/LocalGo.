generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//////////////////////
// ENUMS
//////////////////////

enum Role {
  OWNER
  RENTER
  ADMIN
}

enum CarType {
  SEDAN
  SUV
  HATCHBACK
  PICKUP
  VAN
}

enum DriveType {
  SELF_DRIVE
  WITH_DRIVER
}

enum BookingStatus {
  PENDING_PAYMENT
  PENDING_CONFIRMATION
  ACTIVE
  COMPLETED
  CANCELLED
}

enum TransactionType {
  PAYIN
  RENTAL_PENDING
  RENTAL_RELEASE
  WITHDRAW
}

enum TransactionStatus {
  PENDING
  SUCCESS
  FAILED
}

enum ContractStatus {
  PENDING
  PAID
  CANCELLED
  REFUNDED
  EXPIRED
}

enum OwnerApplicationStatus {
  PENDING
  APPROVED
  REJECTED
}

//////////////////////
// USER
//////////////////////

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  passwordHash  String
  name          String
  slug          String?  @unique
  role          Role     @default(RENTER)
  verified      Boolean  @default(true)
  avatar        String?
  wallet        Wallet?
  cars          Car[]

  rentals       Booking[] @relation("Renter")
  rentalsOwned  Booking[] @relation("Owner")

  contractsRented Contract[] @relation("ContractRenter")
  contractsOwned  Contract[] @relation("ContractOwner")

  ownerApplications OwnerApplication[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("user")
}

//////////////////////
// OWNER APPLICATION
//////////////////////

model OwnerApplication {
  id          String   @id @default(uuid())
  slug        String?  @unique

  userId      String
  email       String
  phone       String
  avatar      String?
  bankAccount String

  status      OwnerApplicationStatus @default(PENDING)
  rejectionReason String?

  user        User     @relation(fields: [userId], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("owner_application")
}

//////////////////////
// OTP
//////////////////////

model OtpVerification {
  id        String   @id @default(uuid())
  email     String
  otp       String
  slug      String?  @unique
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
}

//////////////////////
// WALLET
//////////////////////

model Wallet {
  id               String   @id @default(uuid())
  userId           String   @unique
  slug             String?  @unique

  availableBalance Int      @default(0)
  pendingBalance   Int      @default(0)

  user             User     @relation(fields: [userId], references: [id])
  transactions     WalletTransaction[]

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

//////////////////////
// WALLET TRANSACTION
//////////////////////

model WalletTransaction {
  id            String @id @default(uuid())
  slug          String?    @unique

  walletId      String
  bookingId     String?
  contractId    String?

  amount        Int
  type          TransactionType
  status        TransactionStatus

  sepayOrderId  String? @unique
  sepayTransId  String?
  sepayRawData  Json?

  wallet        Wallet   @relation(fields: [walletId], references: [id])
  booking       Booking? @relation(fields: [bookingId], references: [id])
  contract      Contract? @relation(fields: [contractId], references: [id])

  createdAt     DateTime @default(now())
  confirmedAt   DateTime?
}

//////////////////////
// CAR
//////////////////////

model Car {
  id          String   @id @default(uuid())
  slug        String   @unique
  ownerId     String

  brand       String
  name        String
  color       String
  type        CarType
  seats       Int
  driveType   DriveType
  pricePerDay Int
  description String?
  image       String?


  owner       User     @relation(fields: [ownerId], references: [id])
  bookings    Booking[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

//////////////////////
// BOOKING
//////////////////////

model Booking {
  id          String @id @default(uuid())
  slug        String?    @unique

  carId       String
  renterId    String
  ownerId     String

  startDate   DateTime
  endDate     DateTime
  totalPrice  Int

  status      BookingStatus @default(PENDING_PAYMENT)

  car         Car   @relation(fields: [carId], references: [id])
  renter      User  @relation("Renter", fields: [renterId], references: [id])
  owner       User  @relation("Owner", fields: [ownerId], references: [id])

  transactions WalletTransaction[]
  contract     Contract?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

//////////////////////
// CONTRACT
//////////////////////

model Contract {
  id          String @id @default(uuid())
  slug        String?    @unique

  bookingId   String @unique
  renterId    String
  ownerId     String

  totalAmount Int
  status      ContractStatus @default(PENDING)

  booking     Booking @relation(fields: [bookingId], references: [id])
  renter      User    @relation("ContractRenter", fields: [renterId], references: [id])
  owner       User    @relation("ContractOwner", fields: [ownerId], references: [id])

  transactions WalletTransaction[]

  createdAt   DateTime @default(now())
  paidAt      DateTime?
}
