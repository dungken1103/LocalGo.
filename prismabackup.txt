generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//////////////////////
// ENUMS
//////////////////////

enum Role {
  OWNER
  RENTER
  ADMIN
}

enum CarType {
  SEDAN
  SUV
  HATCHBACK
  PICKUP
  VAN
}

enum DriveType {
  SELF_DRIVE
  WITH_DRIVER
}

enum BookingStatus {
  PENDING_PAYMENT      // ch∆∞a pay
  PENDING_CONFIRMATION // ƒë√£ pay, ch·ªù x√°c nh·∫≠n xe ƒë√∫ng m√¥ t·∫£
  ACTIVE
  COMPLETED
  CANCELLED
}

enum TransactionType {
  PAYIN            // ti·ªÅn t·ª´ SePay
  RENTAL_PENDING   // ti·ªÅn gi·ªØ
  RENTAL_RELEASE   // pending -> access
  WITHDRAW
}

enum TransactionStatus {
  PENDING
  SUCCESS
  FAILED
}

//////////////////////
// USER
//////////////////////

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  passwordHash  String
  name          String
  role          Role     @default(RENTER)
  verified      Boolean  @default(true)
  slug          String

  wallet        Wallet?
  cars          Car[]

  rentals       Booking[] @relation("Renter")
  rentalsOwned  Booking[] @relation("Owner")

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("user")
}

//////////////////////
// OTP
//////////////////////

model OtpVerification {
  id        String   @id @default(uuid())
  email     String
  otp       String
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
}

//////////////////////
// WALLET
//////////////////////

model Wallet {
  id               String   @id @default(uuid())
  userId           String   @unique

  availableBalance Int      @default(0) // ti·ªÅn access
  pendingBalance   Int      @default(0) // ti·ªÅn ch·ªù x√°c nh·∫≠n

  user             User     @relation(fields: [userId], references: [id])
  transactions     WalletTransaction[]

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

//////////////////////
// WALLET TRANSACTION
//////////////////////

model WalletTransaction {
  id            String @id @default(uuid())

  walletId      String
  bookingId     String?

  amount        Int
  type          TransactionType
  status        TransactionStatus

  // SePay data
  sepayOrderId  String? @unique
  sepayTransId  String?
  sepayRawData  Json?

  wallet        Wallet   @relation(fields: [walletId], references: [id])
  booking       Booking? @relation(fields: [bookingId], references: [id])

  createdAt     DateTime @default(now())
  confirmedAt   DateTime?
}

//////////////////////
// CAR
//////////////////////

model Car {
  id          String   @id @default(uuid())
  ownerId     String

  brand       String
  name        String
  color       String
  type        CarType
  seats       Int
  driveType   DriveType
  pricePerDay Int
  description String?

  owner       User     @relation(fields: [ownerId], references: [id])
  bookings    Booking[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

//////////////////////
// BOOKING
//////////////////////

model Booking {
  id          String @id @default(uuid())

  carId       String
  renterId    String
  ownerId     String

  startDate   DateTime
  endDate     DateTime
  totalPrice  Int

  status      BookingStatus

  car         Car   @relation(fields: [carId], references: [id])
  renter      User  @relation("Renter", fields: [renterId], references: [id])
  owner       User  @relation("Owner", fields: [ownerId], references: [id])

  transactions WalletTransaction[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}


// import { NestFactory } from '@nestjs/core';
// import { ValidationPipe } from '@nestjs/common';
// import { AppModule } from './app.module';
// import { SwaggerModule, DocumentBuilder } from '@nestjs/swagger';
// import { NestExpressApplication } from '@nestjs/platform-express';
// import { join, resolve } from 'path';

// async function bootstrap() {
//   const allowedOrigins = [
//     'http://localhost:5173',
//   ];

//   const app = await NestFactory.create<NestExpressApplication>(AppModule);

//   app.enableCors({
//     origin: (origin, callback) => {
//       const allowedOrigins = [
//         'http://localhost:5173',
//       ];

//       // ‚ùå N·∫øu kh√¥ng c√≥ origin ‚Üí ch·∫∑n (truy c·∫≠p tr·ª±c ti·∫øp t·ª´ browser)
//       if (!origin) {
//         return callback(
//           new Error('CORS blocked: Direct browser access is not allowed.'),
//         );
//       }

//       // ‚úî Domain h·ª£p l·ªá ‚Üí cho ph√©p
//       if (allowedOrigins.includes(origin)) {
//         return callback(null, true);
//       }

//       // ‚ùå Domain kh√¥ng h·ª£p l·ªá ‚Üí ch·∫∑n
//       return callback(new Error('Not allowed by CORS'));
//     },
//     credentials: true,
//   });

//   app.useStaticAssets(resolve('uploads'), {
//     prefix: '/uploads',
//   });

//   // ‚úÖ Global pipes
//   app.useGlobalPipes(
//     new ValidationPipe({
//       whitelist: true,
//       transform: true,
//     }),
//   );

//   // ‚úÖ Swagger setup
//   const config = new DocumentBuilder()
//     .setTitle('BookShop API')
//     .setDescription('API documentation for the book store platform')
//     .setVersion('1.0')
//     .addBearerAuth()
//     .build();

//   const document = SwaggerModule.createDocument(app, config);
//   SwaggerModule.setup('api', app, document);

//   const PORT = process.env.PORT ?? 3212;
//   await app.listen(PORT, '0.0.0.0');

//   console.log(`üöÄ Server is running on http://localhost:${PORT}`);
//   console.log(`üìö Swagger docs available at http://localhost:${PORT}/api`);
// }
// bootstrap();
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';
import { SwaggerModule, DocumentBuilder } from '@nestjs/swagger';
import * as cookieParser from 'cookie-parser';

async function bootstrap() {
  const allowedOrigins = [
    'http://localhost:5173',
  ];

  const app = await NestFactory.create(AppModule, {
    cors: {
      origin: allowedOrigins,
      credentials: true,
    },
  });

  const config = new DocumentBuilder()
    .setTitle('E-Learning API')
    .setDescription('API documentation for the e-learning platform')
    .setVersion('1.0')
    .addBearerAuth()
    .build();

  const document = SwaggerModule.createDocument(app, config);
  SwaggerModule.setup('api', app, document);

  const PORT = process.env.PORT ?? 3212;
  await app.listen(PORT, '0.0.0.0');

  console.log(`üöÄ Server is running on http://localhost:${PORT}`);
  console.log(`üìö Swagger docs available at http://localhost:${PORT}/api`);
}
bootstrap();
